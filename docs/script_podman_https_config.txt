#!/bin/bash

set -e

###############################################
# C·∫§U H√åNH BI·∫æN
###############################################
N8N_IMAGE="docker.io/n8nio/n8n:latest"
CADDY_IMAGE="docker.io/library/caddy:latest"
CUSTOM_N8N_IMAGE="localhost/n8n_puppeteer:latest"
N8N_CONTAINER_NAME="n8n"
CADDY_CONTAINER_NAME="caddy"
N8N_PORT=5678
CADDY_PORT=8443
DOMAIN="localhost"
BASE_FOLDER="n8n_podman"
N8N_FOLDER="$BASE_FOLDER/n8n"
CADDY_FOLDER="$BASE_FOLDER/caddy"
CERT_PATH="$BASE_FOLDER/certs"
NETWORK_NAME="n8n_network"

N8N_VOLUME="n8n_podman_n8n"
CADDY_VOLUME="n8n_podman_caddy"
CERT_VOLUME="n8n_podman_certs"
CADDYFILE_PATH="$CADDY_FOLDER/Caddyfile"

###############################################
# T·∫†O TH∆Ø M·ª§C CH√çNH V√Ä C√ÅC TH∆Ø M·ª§C CON
###############################################
mkdir -p "$N8N_FOLDER" "$CADDY_FOLDER" "$CERT_PATH"

###############################################
# T·∫†O NETWORK N·∫æU CH∆ØA C√ì
###############################################
if ! podman network exists $NETWORK_NAME; then
  echo "T·∫°o network $NETWORK_NAME"
  podman network create $NETWORK_NAME
else
  echo "Network $NETWORK_NAME ƒë√£ t·ªìn t·∫°i"
fi

###############################################
# T·∫†O CH·ª®NG CH·ªà T·ª∞ K√ù
###############################################
if [ ! -f "$CERT_PATH/localhost.pem" ] || [ ! -f "$CERT_PATH/localhost-key.pem" ]; then
  echo "T·∫°o ch·ª©ng ch·ªâ t·ª± k√Ω"
  openssl req -x509 -newkey rsa:4096 -keyout "$CERT_PATH/localhost-key.pem" -out "$CERT_PATH/localhost.pem" -days 365 -nodes -subj "/CN=$DOMAIN"
else
  echo "Ch·ª©ng ch·ªâ ƒë√£ t·ªìn t·∫°i, b·ªè qua b∆∞·ªõc t·∫°o"
fi

###############################################
# T·∫†O CUSTOM N8N IMAGE V·ªöI PUPPETEER TR√äN ALPINE
###############################################
cat <<EOF > $BASE_FOLDER/Dockerfile
FROM node:18-alpine

# C√†i Puppeteer v√† Chromium
RUN apk add --no-cache \
    chromium \
    nss \
    freetype \
    harfbuzz \
    ca-certificates \
    ttf-freefont && \
    npm install -g n8n puppeteer && \
    npm cache clean --force && \
    rm -rf /tmp/* /var/cache/apk/* /root/.npm /root/.node-gyp /home/node/.npm /home/node/.node-gyp

# T·∫°o th∆∞ m·ª•c c·∫•u h√¨nh v√† g√°n quy·ªÅn ch√≠nh x√°c
RUN mkdir -p /home/node/.n8n && chown -R node:node /home/node/.n8n && chmod -R 700 /home/node/.n8n

# Ch·∫°y d∆∞·ªõi quy·ªÅn node
USER node

# C·∫•u h√¨nh th∆∞ m·ª•c l√†m vi·ªác
WORKDIR /home/node

# Kh·ªüi ƒë·ªông n8n
CMD ["n8n"]
EOF

echo "üöÄ ƒêang build custom image n8n v·ªõi Puppeteer tr√™n Alpine..."
podman build -t $CUSTOM_N8N_IMAGE $BASE_FOLDER
rm $BASE_FOLDER/Dockerfile

###############################################
# CH·∫†Y N8N CONTAINER V·ªöI IMAGE M·ªöI
###############################################
podman run -d \
  --name $N8N_CONTAINER_NAME \
  --network $NETWORK_NAME \
  -e N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false \
  -v "$N8N_VOLUME:/home/node/.n8n:Z" \
  -p $N8N_PORT:5678 \
  $CUSTOM_N8N_IMAGE

###############################################
# T·∫†O FILE CADDYFILE
###############################################
CADDYFILE="$CADDY_FOLDER/Caddyfile"
cat <<EOL > "$CADDYFILE"
:8443 {
    reverse_proxy $N8N_CONTAINER_NAME:$N8N_PORT
    tls /etc/caddy/certs/localhost.pem $CERT_PATH/localhost-key.pem
    log {
        output stdout
        level DEBUG
    }
}
EOL

###############################################
# CH·∫†Y CADDY CONTAINER
###############################################
# old
# podman run -d \
#   --name $CADDY_CONTAINER_NAME \
#   --network $NETWORK_NAME \
#   -p $CADDY_PORT:8443 \
#   -v "$(pwd)/$CADDYFILE_PATH:/etc/caddy/Caddyfile:Z" \
#   -v "$CERT_VOLUME:/etc/caddy/certs" \
#   $CADDY_IMAGE
podman run -d \
  --name $CADDY_CONTAINER_NAME \
  --network $NETWORK_NAME \
  -p $CADDY_PORT:8443 \
  -v "$(pwd)/$CADDYFILE_PATH:/etc/caddy/Caddyfile:Z" \
  -v "$CERT_PATH:/etc/caddy/certs" \
  $CADDY_IMAGE
# CADDY_FOLDER = n8n_podman/caddy
# n8n_podman/caddy/Caddyfile
# ok - test
 # podman run -d \
 #  --name caddy \
 #  --network n8n_network \
 #  -p 8443:8443 \
 #  -v "$(pwd)/n8n_podman/caddy/Caddyfile:/etc/caddy/Caddyfile:Z" \
 #  -v "$(pwd)/n8n_podman/certs:/etc/caddy/certs:Z" \
 #  docker.io/library/caddy:latest

###############################################
# TH√îNG B√ÅO HO√ÄN TH√ÄNH
###############################################
echo "‚úÖ ƒê√£ ho√†n th√†nh c√†i ƒë·∫∑t n8n v·ªõi Puppeteer v√† HTTPS tr√™n Podman!"
echo "üëâ Truy c·∫≠p: https://localhost:$CADDY_PORT"
